<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Authentication Success</title>
    </head>
    <body>
        <script>
        var run_on_load = function() {
            var origin = window.location.origin;
            if(window != window.top && window != window.parent ) {
                console.log('Not main window/tab.');
                var message = 'error';
                if (window.location.hash.indexOf('access_token') !== -1) {
                    message = '{"token":"' + window.location.hash.replace(/^.*access_token=([^&]+).*$/, '$1') +
                    '","expires_in":' + parseInt(window.location.hash.replace(/^.*expires_in=([^&]+).*$/, '$1')) + '}';
                } else if (window.location.search.indexOf('code') !== -1) {
                    message = '{"code":"' + window.location.search.replace(/^.*code=([^&]+).*$/, '$1') + '"}';
                }
                try {
                    // Standards based browsers
                    parent.postMessage(message, origin);
                } catch(e) {
                    console.error(e);
                }
            } else {
                console.log('Main Window/Tab');
                var data = window.location.hash ? window.location.hash : window.location.search;
                var loc = localStorage.getItem('oauth_redirect');
                if(loc){
                    console.log('Redirecting to ' + loc);
                    if(loc.indexOf('?') >= 0) {
                            // Remove hash if data is a hash
                        data = data.indexOf('?') >= 0 ? '&' + data.substr(data.indexOf('?')+1) : data;
                    } else if(loc.indexOf('#')){
                            // Remove question mark if data is query.
                        data = data.indexOf('#') >= 0 ? '&' + data.substr(data.indexOf('?')+1) : data;
                    }
                    window.location.href = loc + data;
                } else window.location.href = origin + data;
            }
        };
        if (window.addEventListener) {
            window.addEventListener("DOMContentLoaded", run_on_load);
        } else {
            run_on_load();  // IE 8
        }
        </script>
    </body>
</html>
